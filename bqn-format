#!/usr/bin/env bqn

c  â‡ â€¢Import "deps/color.bqn"
s  â‡ â€¢Import "deps/string.bqn"
fs â‡ â€¢Import "deps/file_system.bqn"
fn â‡ â€¢Import "deps/fun.bqn"

Align â† { wğ•Šğ•©:
    n â† âŒˆÂ´{+Â´âˆ¨`âŒ¾âŒ½' 'â‰ âŠ‘w s.Splitğ•©}Â¨ğ•©
    {(' 'âˆ¾wâˆ¾' ')s.Join s.TrimÂ¨âŒ¾(1âŠ¸â†“) nâŠ¸â†‘âŒ¾âŠ‘w s.Splitğ•©}Â¨ğ•©
}

Va â† {âˆ§Â´ğ•©âˆŠ"âŸ¨âŸ©_, "âˆ¾âˆ¾"0Aa"+âŸœâ†•Â¨10â€¿26â€¿26}                       # varaible or array
Aa â† {({âŠ‘VaÂ¨(1â†‘"â†"âŠ¸s.Split)ğ•©}âˆ§(=Â´Â·+Â´Ë˜"{}"=âŒœâŠ¢)âˆ§(âˆ¨Â´"â†"âˆŠËœâŠ¢))ğ•©} # assignment alignable
Ca â† {(âˆ¨Â´'#'=ğ•©)âˆ§âˆ¨Â´' 'â‰ (âˆ§`'#'âŠ¸â‰ )âŠ¸/ğ•©}                         # comment alignable

FormatSingleFile â† {
    l â† â€¢file.Lines ğ•©
    l â†© {(Â¬Â·âˆ§`âŒ¾âŒ½' 'âŠ¸=)âŠ¸/ğ•©}Â¨l            # remove trailing whitespace
    g â† Aa fn._ChunkKeyâŠ¸âŠ” l             # create chunks for aligning â†
    l â†© âˆ¾{ AaâŠ‘ğ•© ? "â†" Align ğ•© â‹„ ; ğ•© }Â¨g # align â† symbols
    g â†© Ca fn._ChunkKeyâŠ¸âŠ” l             # create chunks for aligning #
    l â†© âˆ¾{ CaâŠ‘ğ•© ? "#" Align ğ•© â‹„ ; ğ•© }Â¨g # align # symbols
    ğ•© â€¢file.Lines l
}

main â† {
    (c.Red "Must provide directory") ! 0â‰ â‰ â€¢args
    d â† { "."â‰¡0âŠ‘â€¢args ? â€¢wdpath ; â€¢wdpathâˆ¾"/"âˆ¾0âŠ‘â€¢args } # directory or file
    { 'f'â‰¡â€¢file.Type d ? FormatSingleFile d 
                       ; FormatSingleFileÂ¨ fs.ListRecursiveBQNFiles d }
    â€¢Out "All files formatted! ğŸ¥³"
}
