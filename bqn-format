#!/usr/bin/env bqn

c  â‡ â€¢Import "deps/color.bqn"
s  â‡ â€¢Import "deps/string.bqn"
fs â‡ â€¢Import "deps/file_system.bqn"
fn â‡ â€¢Import "deps/fun.bqn"

AlignAssignments â† {
    n â† âŒˆÂ´{+Â´âˆ¨`âŒ¾âŒ½' 'â‰ âŠ‘"â†"s.Splitğ•©}Â¨ğ•©
    {" â† " s.Join s.TrimÂ¨âŒ¾(1âŠ¸â†“) nâŠ¸â†‘âŒ¾âŠ‘"â†"s.Splitğ•©}Â¨ğ•©
}

Va â† {âˆ§Â´ğ•©âˆŠ"âŸ¨âŸ©_, "âˆ¾âˆ¾"0Aa"+âŸœâ†•Â¨10â€¿26â€¿26}                       # varaible or array
Aa â† {({âŠ‘VaÂ¨(1â†‘"â†"âŠ¸s.Split)ğ•©}âˆ§(=Â´Â·+Â´Ë˜"{}"=âŒœâŠ¢)âˆ§(âˆ¨Â´"â†"âˆŠËœâŠ¢))ğ•©} # assignment alignable

FormatSingleFile â† {
    l â† â€¢file.Lines ğ•©
    l â†© {(Â¬Â·âˆ§`âŒ¾âŒ½' 'âŠ¸=)âŠ¸/ğ•©}Â¨l     # remove trailing whitespace
    g â† {0âˆ¾+`fn.Differ AaÂ¨ğ•©}âŠ¸âŠ” l # align assignment symbols # TODO see if we can remove differ
    l â†© âˆ¾{ AaâŠ‘ğ•© ? AlignAssignments ğ•© â‹„ ; ğ•© }Â¨g
    ğ•© â€¢file.Lines l
}

main â† {
    (c.Red "Must provide directory") ! 0â‰ â‰ â€¢args
    d â† { "."â‰¡0âŠ‘â€¢args ? â€¢wdpath ; â€¢wdpathâˆ¾"/"âˆ¾0âŠ‘â€¢args } # directory or file
    { 'f'â‰¡â€¢file.Type d ? FormatSingleFile d 
                       ; FormatSingleFileÂ¨ fs.ListRecursiveBQNFiles d }
    â€¢Out "All files formatted! ğŸ¥³"
}
