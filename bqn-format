#!/usr/bin/env bqn

c  â‡ â€¢Import "deps/color.bqn"
s  â‡ â€¢Import "deps/string.bqn"
fs â‡ â€¢Import "deps/file_system.bqn"
fn â‡ â€¢Import "deps/fun.bqn"

Asm â† {Â¬(â‰ `âŠ¸âˆ¨)"'"""âˆŠËœğ•©} # anti string mask # TODO fix
Va  â† {âˆ§Â´ğ•©âˆŠ"âŸ¨âŸ©_, "âˆ¾âˆ¾"0Aa"+âŸœâ†•Â¨10â€¿26â€¿26}                        # varaible or array
Aa  â† (âŠ‘Â·VaÂ¨(1â†‘"â†"âŠ¸s.Split))âˆ§(=Â´Â·+Â´Ë˜"{}"=âŒœâŠ¢)âˆ§(âˆ¨Â´(Asmâˆ§"â†"âˆŠËœâŠ¢)) # assignment alignable
Ca  â† {(âˆ¨Â´(Asmâˆ§'#'âŠ¸=)ğ•©)âˆ§âˆ¨Â´' 'â‰ (âˆ§`(Asmâˆ§'#'âŠ¸â‰ ))âŠ¸/ğ•©}             # comment alignable

Align â† { wğ•Šğ•©:
    Sma â† (Asmâˆ§âˆŠâŸœw)âŠ¸s.SplitMask  # split mask with asm
    n   â† âŒˆÂ´(+Â´Â·âˆ¨`âŒ¾âŒ½' 'â‰ âŠ‘âˆ˜Sma)Â¨ğ•© # length for alignment
    {(' 'âˆ¾wâˆ¾' ')s.Join s.TrimÂ¨âŒ¾(1âŠ¸â†“)nâŠ¸â†‘âŒ¾âŠ‘Sma ğ•©}Â¨ğ•©
}

FormatSingleFile â† {
    l â† â€¢file.Lines ğ•©
    l â†© {(Â¬Â·âˆ§`âŒ¾âŒ½' 'âŠ¸=)âŠ¸/ğ•©}Â¨l            # remove trailing whitespace
    g â† Aa fn._ChunkKey l               # create chunks for aligning
    l â†© âˆ¾{ AaâŠ‘ğ•© ? "â†" Align ğ•© â‹„ ; ğ•© }Â¨g # align â† symbols
    g â†© Ca fn._ChunkKey l               # create chunks for aligning
    l â†© âˆ¾{ CaâŠ‘ğ•© ? "#" Align ğ•© â‹„ ; ğ•© }Â¨g # align # symbols
    ğ•© â€¢file.Lines l
}

main â† {
    (c.Red "Must provide directory") ! 0â‰ â‰ â€¢args
    a â† 0âŠ‘â€¢args                                             # 1st argument
    d â† { "."â‰¡a ? â€¢wdpath ; ('/'âŠ¸=Â·âŠ‘a)â—¶âŸ¨â€¢wdpathâˆ¾"/"âˆ¾âŠ¢,âŠ¢âŸ©a } # directory or file
    { 'f'â‰¡â€¢file.Type d ? FormatSingleFile d
                       ; FormatSingleFileÂ¨ fs.ListRecursiveBQNFiles d }
    â€¢Out "All files formatted! ğŸ¥³"
}
